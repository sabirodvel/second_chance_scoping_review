---
title: "Data Viz for March 27th Webinar"
author: "VALERA Camille Beatrice"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    theme: cosmo
    toc: yes
    toc_float: yes
    css: !expr here::here("scripts/toc_custom.css")
editor_options: 
  chunk_output_type: inline
  markdown: 
    wrap: none
---

```{r global_chunk options, include = F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

```{r initial_setup}
if(!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, 
               here, 
               janitor, 
               reactable, 
               sf, 
               rnaturalearth, 
               reactable,
               countrycode,
               plotly, 
               ggrepel,
               treemap, #package to create treemap
               RColorBrewer,
               patchwork,
               ggfittext
               )
```

```{r dataset_load, include = F}
included_studies_mar10 <- read_csv(here("data/included_studies_march_10.csv"))
extracted_studies_mar10 <- read_csv(here("data/extracted_studies_march_10.csv"))
```

# Preliminary Findings
## Research Distribution & Trends

```{r publications over time}
publications_over_time <- included_studies_mar10 %>%
  group_by(`Published Year`) %>%
  summarise(Count = n()) %>%
  arrange(`Published Year`)

# Static plot
publications_years <- publications_over_time %>%
  ggplot(aes(x = `Published Year`, y = Count)) +
  geom_line(color = "#1F968BFF", linewidth = 1) +
  geom_smooth(color = "darkgray", fill = "lightgray", size = 1, method = "loess") + # Add smooth line to show trend
  geom_point(color = "#440154FF", size = 2) +
  scale_x_continuous(breaks = seq(min(publications_over_time$`Published Year`), max(publications_over_time$`Published Year`), by = 5)) +  # Set x-axis in 5-year increments
  labs(
    title = "Research Output on Plastic Reconstructive Surgery in Sub-Saharan Africa",
    subtitle = "Tracking the number of studies published over time to understand growth \n of Plastic Reconstructive Surgery Research in SSA.",
    x = "Publication Year (5-year intervals)",
    y = "Number of Published Studies"
  ) +
  theme_minimal()
publications_years

# Interactive plot
# ggplotly(publications_years) 

```

```{r choropleth cleaning country names, include = F}
#Filter dataset to keep only rows where Reviewer Name is "Consensus"
filtered_consensus <- extracted_studies_mar10 %>%
  filter(`Reviewer Name` == "Consensus") %>%
  distinct(`Covidence #`, .keep_all = TRUE)

unique(filtered_consensus$"Country")

# Build a vector of valid country names using the countrycode package
valid_countries <- unique(c(
  countrycode::codelist$country.name.en,   # Standard country names
  countrycode::codelist$country.name.en.regex  # Alternative names
))

# Function to extract country names from mixed text.
# If no valid country is found, it returns the original text (trimmed).
extract_countries <- function(text) {
  if (is.na(text) || text == "") return(text)  # Instead of NA, return the original text
  
# Split the countries by common delimiters (commas, semicolons, parentheses, colons)
split_countries <- unlist(str_split(text, "[;,():]"))
split_countries <- str_trim(split_countries)  # Remove extra whitespace
  
# Filter counrties that are recognized as valid country names
extracted <- split_countries[split_countries %in% valid_countries]
  
# If at least one valid country is found, return unique valid names.
# Otherwise, return the original text (preserving regional responses)
  if (length(extracted) > 0) {
    return(unique(extracted))
  } else {
    return(text)
  }
}

# Apply the extraction function to the main dataframe without dropping other columns.
# This keeps your "Covidence #" and other columns intact.
cleaned_country_data <- filtered_consensus %>%
  mutate(Country = lapply(Country, extract_countries)) %>%  # Process each cell in Country column
  unnest(Country)  # Expand list-column so each country is its own row
```

```{r choropleth of study distribution}

# Process data: Count occurrences per country
country_counts <- cleaned_country_data %>% 
  count(Country, name = "study_count") %>%
  arrange(desc(study_count))  # Sort by study count

# Identify the top 5 countries with the highest study counts
top_countries <- country_counts %>% 
  slice_max(study_count, n = 5, with_ties = FALSE)

# Load African map data
africa <- ne_countries(scale = "medium", continent = "Africa", returnclass = "sf")

# Merge study data with map
africa_data <- africa %>%
  left_join(country_counts, by = c("name" = "Country"))

# Define color scale
study_fill_scale <- scale_fill_distiller(
  palette = "YlGnBu", 
  na.value = "white", 
  name = "Study Count",
  direction = 1,
  breaks = seq(0, max(country_counts$study_count), by = 2),  # Set custom breaks
  labels = seq(0, max(country_counts$study_count), by = 2)  # Set custom labels
)

# Plot the refined choropleth map
geo_distribution <- ggplot(data = africa_data) +
  geom_sf(aes(fill = study_count), color = "gray50", size = 0.3) +
  study_fill_scale +
  labs(title = "Distribution of Studies on Plastic Reconstructive Surgery in Sub-Saharan Africa",
       subtitle = "Top 10 Countries with the most studies.",
       caption = "Source: Covidence 'Data Charting' Dataset") +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        panel.grid = element_blank()
        )
geo_distribution 

```

```{r barplot of study distribution, include = F}

barplot_choro <- country_counts %>%
  arrange(desc(study_count)) %>%
  head(10) %>%
  mutate(percentage = study_count / sum(study_count) * 100) %>%
  ggplot(aes(x = reorder(Country, percentage), y = percentage, fill = percentage)) +
  geom_bar(stat = "identity") +
  scale_fill_gradientn(colors = RColorBrewer::brewer.pal(9, "YlGnBu")) +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), 
            hjust = 2.5,
            vjust = 0.5,
            color = "black", 
            fontface = "bold") +  
  theme_minimal() +
  labs(title = "Share of Studies") +
  coord_flip() +
  theme(axis.text.x = element_blank(),  
        axis.ticks = element_blank(),    
        axis.title = element_blank(),
        legend.position = "none",
        panel.grid = element_blank())
barplot_choro 
```

```{r choropleth and bar}
combined_choro_bar <- 
  geo_distribution + inset_element(barplot_choro + theme(text = element_text(size = 8)),
                                   left = 0, bottom = 0, right = 0.5, top = 0.5 )
combined_choro_bar
```

# Greyed out African Countries

```{r}

# Define Sub-Saharan Africa countries (excluding South Africa)
ssa_countries <- c("Angola", "Benin", "Botswana", "Burkina Faso", "Burundi", 
                   "Cabo Verde", "Cameroon", "Central African Republic", "Chad", 
                   "Comoros", "Congo", "Democratic Republic of the Congo", "Djibouti", 
                   "Equatorial Guinea", "Eritrea", "Eswatini", "Ethiopia", "Gabon", 
                   "Gambia", "Ghana", "Guinea", "Guinea-Bissau", "Ivory Coast", "Kenya", 
                   "Lesotho", "Liberia", "Madagascar", "Malawi", "Mali", "Mauritania", 
                   "Mauritius", "Mozambique", "Namibia", "Niger", "Nigeria", "Rwanda", 
                   "São Tomé and Príncipe", "Senegal", "Seychelles", "Sierra Leone", 
                   "Somalia", "South Sudan", "Sudan", "Tanzania", "Togo", "Uganda", 
                   "Zambia", "Zimbabwe")

# Load African map data
africa <- ne_countries(scale = "medium", continent = "Africa", returnclass = "sf")

# Process data: Count occurrences per country
country_counts <- cleaned_country_data %>% 
  count(Country, name = "study_count") %>%
  arrange(desc(study_count))

# Merge study data with Africa map
africa_data <- africa %>%
  left_join(country_counts, by = c("name" = "Country")) %>%
  mutate(
    is_ssa = name %in% ssa_countries,  # Flag SSA countries
    is_south_africa = name == "South Africa",  # Flag South Africa
    has_study = !is.na(study_count)  # Flag countries with studies
  )

# Define color scale for SSA countries
study_fill_scale <- scale_fill_distiller(
  palette = "YlGnBu", 
  na.value = "white",  # SSA countries without studies should be white
  name = "Study Count",
  direction = 1,
  breaks = seq(0, max(country_counts$study_count, na.rm = TRUE), by = 2),
  labels = seq(0, max(country_counts$study_count, na.rm = TRUE), by = 2)
)

# Plot refined choropleth map
geo_distribution <- ggplot(data = africa_data) +
  # Color only SSA countries with studies
  geom_sf(aes(fill = ifelse(is_ssa & has_study, study_count, NA)), 
          color = "gray50", size = 0.3) +  
  # Grey out South Africa
  geom_sf(data = africa_data %>% filter(is_south_africa), 
          fill = "gray", color = "gray50", size = 0.3) +  
  # Grey out non-SSA countries that have studies
  geom_sf(data = africa_data %>% filter(!is_ssa & has_study), 
          fill = "gray", color = "gray50", size = 0.3) +  
  study_fill_scale +
  labs(title = "Distribution of Studies on Plastic Reconstructive Surgery in Sub-Saharan Africa",
       subtitle = "Only Sub-Saharan African countries with studies are colored.",
       caption = "Source: Covidence 'Data Charting' Dataset") +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        panel.grid = element_blank())

geo_distribution


```
```{r}
combined_choro_bar <- 
  geo_distribution + inset_element(barplot_choro + theme(text = element_text(size = 8)),
                                   left = 0, bottom = 0, right = 0.5, top = 0.5 )
combined_choro_bar
```


# Pathologies

## General Pathologies

```{r treemap of general pathologies prep, include = F}
# Adding source code here - C.V.
source(here("scripts/extracted_data_cleaning.R"))

# Create frequency table
pathology_distribution <- categorized_general_pathology %>% 
  separate_rows(category_gen_pathology, sep = "; ") %>%
  filter(!is.na(category_gen_pathology)) %>%  # Remove NA values
  group_by(category_gen_pathology) %>% 
  summarize(n = n(),
            percentage = 
              round(100 * n() / nrow(categorized_general_pathology), 2)) %>%
  ungroup() %>% 
  arrange(desc(n))

# # Create simple treemap
# treemap(pathology_distribution,
#             index="category_gen_pathology",
#             vSize="n",
#             type="index")

# Customized treemap
data_tree <- treemap(pathology_distribution,
        index = "category_gen_pathology",  # Define the category to index by
        vSize = "n",                       # Define the size based on 'n'
        type = "index",                    # Type of treemap (index-based)
        # palette = "YlGnBu",                 # Custom color palette
        # title = "Pathology Distribution",   # Custom title
        # fontsize.labels = 10,               # Adjust label font size
        # fontcolor.labels = "black",      # Label font color
        # align.labels = c("center", "center"),  # Align labels in the center
        # border.col = "white",              # Border color around boxes
        # border.lw = 2
        )

# More refined treemap
data_ggplot <- data_tree[["tm"]] %>%
  as_tibble() %>%
  arrange(desc(vSize)) %>%
  mutate(
    rank = row_number(),
    xmax = x0 + w,
    ymax = y0 + h,
    label_pathology = str_glue("{category_gen_pathology}\n(n={vSize})")
  )
```

```{r treemap of general pathologies graph}
p1 <- 
  ggplot(data_ggplot) +
  geom_rect(aes(xmin = x0,
                ymin = y0,
                xmax = xmax,
                ymax = ymax,
                fill = category_gen_pathology),
            size = 2,
            colour = "white",
            alpha = 0.9) +
  geom_fit_text(aes(xmin = x0,
                    xmax = xmax,
                    ymin = y0,
                    ymax = ymax,
                    label = label_pathology),
                color = ifelse(
                  data_ggplot$category_gen_pathology == "Trauma", "white", "black"),
                min.size = 1,   # Minimum font size to avoid tiny text
                reflow = TRUE,   # Wrap text to fit the box
                ) +
  scale_fill_brewer(palette = "YlGnBu",
                    direction = 1) +  
  labs(title = "Distribution of Pathologies Requiring Reconstructive Surgery in Sub-Saharan Africa") +
  theme_void() +
  theme(legend.position = "none")  

# Display plot
p1

# Save treemap
# ggsave(filename = here("images/general_treemap.png"))

#ggplotly(p1) # Interactive plot (to be refined if needed)
```

## Specific Pathologies

```{r treemap subgroup}
# Add source code
source(here("scripts/extracted_data_cleaning.R"))

# Create frequency table 
specific_pathology_distribution <- categorized_specific_pathology %>% 
  separate_rows(category_specific_pathology, sep = "; ") %>%
  filter(!is.na(category_specific_pathology)) %>%  # Remove NA values
  group_by(category_specific_pathology) %>% 
  summarize(n = n(),
            percentage = 
              round(100 * n() / nrow(categorized_specific_pathology), 2)) %>%
  ungroup() %>% 
  arrange(desc(n)) %>% 
  mutate(category_gen_pathology = 
           case_when(category_specific_pathology == "Cleft & Craniofacial" |
                       category_specific_pathology == "Limb Deformities"
                     ~ "Congenital Malformations",
                     category_specific_pathology == "Contractures" |
                      category_specific_pathology == "Acute Burns" |
                       category_specific_pathology == "Burn Scars"
                      ~ "Burns",
                     category_specific_pathology == "Severe Injuries" |
                       category_specific_pathology == "Soft Tissue Injuries"
                     ~ "Trauma",
                     category_specific_pathology == "Noma" |
                      category_specific_pathology == "Other Infections" 
                     ~ "Infectious Conditions",
                     category_specific_pathology == "Cancer" |
                       category_specific_pathology == "Other Neoplasms" 
                     ~ "Neoplasms"))


# Create the treemap plot
data_tree_2 <- treemap(specific_pathology_distribution,
        index = c("category_gen_pathology", "category_specific_pathology"),
        vSize = "n",                       
        type = "index",                    
        palette = "YlGnBu",
        bg.labels = rgb(0.5, 0.5, 0, alpha = 0.2),  # Make background of labels transparent
        align.labels = list(
              c("left", "top"),  # Alignment for general group
              c("center", "center")  # Alignment for specific pathology
        ),
        fontsize.labels = c(10,9),  # Adjust label font size
        fontcolor.labels = c("white", "white"),
        border.col = "white",  # Border color for all boxes
        border.lwds = c(4, 2)
)
```

# Surgical Procedures 

```{r lollipop surgeries}

# Create frequency table
surgery_distribution <- categorized_surgeries %>% 
  separate_rows(category_surgery, sep = "; ") %>%
  filter(!is.na(category_surgery)) %>%  # Remove NA values
  group_by(category_surgery) %>% 
  summarize(n = n(),
            percentage = 
              round(100 * n() / nrow(categorized_surgeries), 2)) %>%
  ungroup() %>% 
  arrange(desc(n))

# Create the lollipop plot
lollipop <- 
  ggplot(surgery_distribution, aes(x = reorder(category_surgery, n), y = n)) +
  geom_segment(aes(xend = category_surgery, yend = 0), color = "gray") +  # Line segment
  geom_point(size = 4, color = "#238AB0") +  # Circular lollipop head
  coord_flip() +  # Flip axes for better readability
  labs(title = "Distribution of Categorized Surgical Procedures",
       x = "Surgical Procedures",
       y = "Count") +
  scale_y_continuous(breaks = seq(0, 15, 2)) +
  theme_minimal()

# Highlight procedures
lollipop_highlight <- 
  ggplot(surgery_distribution, aes(x = reorder(category_surgery, n), y = n)) +
  geom_segment(aes(xend = category_surgery, yend = 0), 
               linewidth = if_else(surgery_distribution$category_surgery == "Soft Tissue & Skin Procedures", 1, 0.5),
               color = if_else(surgery_distribution$category_surgery == "Soft Tissue & Skin Procedures", "#264C9F", "gray")) +  # Line segment
  geom_point(size = if_else(surgery_distribution$category_surgery == "Soft Tissue & Skin Procedures", 4, 2), 
             color = if_else(surgery_distribution$category_surgery == "Soft Tissue & Skin Procedures", "#264C9F", "#238AB0")) +
  coord_flip() +  # Flip axes for better readability
  labs(title = "Distribution of Categorized Surgical Procedures",
       x = "Surgical Procedures",
       y = "Count") +
  scale_y_continuous(breaks = seq(0, 15, 2)) +
  theme_minimal()

# Save image
# ggsave(filename = here("images/surgeries_lollipop_highlight.png"), bg = "white", plot = lollipop, width = 7, height = 4, dpi = 300)
```

# Barriers

## Barriers to Surgical/Reconstructive Surgical 

```{r barriers cleaning, include = F}

filtered_barriers <- filtered_consensus %>% 
  select(`Covidence #`,
         `Health System Barrier`,
         `Financial  Barrier`,
         `Geograhic/Accessibility Barrier`,
         `Sociocultural Barrier`,
         `Patient-Related  Barrier`,
         `Policy/Governance  Barrier`,
         `Education/Training Barrier`,
         `Other Barrier`)

#Transform multiple responses into separate rows
barriers_clean <- filtered_barriers %>%
  pivot_longer(cols = -`Covidence #`, names_to = "Barrier_Type", values_to = "Response") %>%
  filter(!is.na(Response) & Response != "") %>% 
  mutate(Response = str_split(Response, ",|;")) %>%
  unnest(Response) %>%
  mutate(Response = str_trim(Response) %>%
           str_to_lower()
         )
```

```{r barriers response management}

# Manual mapping for each response category within Education/Training Barrier
mapping_list <- list(
   "Education/Training Barrier" = c(
     "lack of trained staff" = "training gaps",
     "surgeon training gaps" = "training gaps",
     "training gaps" = "training gaps",
     "training program in plastic surgery" = "training gaps",
     "educated staff" = "uneducated staff",
     "uneducated" = "uneducated staff"
  ),
  "Financial  Barrier" = c(
    "indirect cost" = "indirect costs",
    "transportation costs" = "indirect costs",
    "direct medical costs" = "direct costs",
    "out-of-pocket costs" = "direct costs",
    "service costs" = "direct costs"
  ),
  "Geograhic/Accessibility Barrier" = c(
    "distance" = "physical distance",
    "travel time" = "physical distance",
    "transportation" = "transportation issues",
    "transportations issues" = "transportation issues",
    "travel" = "physical distance"
  ),
  "Health System Barrier" = c(
    "anaesthesia" = "infrastructure limitations",
    "blood bank" = "infrastructure limitations",
    "electricity" = "infrastructure limitations",
    "health system inefficiencies" = "health system inefficiencies",
    "health system inneficiencies" = "health system inefficiencies",
    "human resource shortage" = "human resource shortages",
    "human resource shortages" = "human resource shortages",
    "inpatient capacity" = "infrastructure limitations",
    "limited infrastructure" = "infrastructure limitations",
    "limited surgical infrastructure" = "infrastructure limitations",
    "number of plastic surgeons" = "human resource shortages",
    "operating rooms" = "infrastructure limitations",
    "referral system" = "referral system issues",
    "referral system issues" = "referral system issues",
    "specialized care" = "infrastructure limitations",
    "treatment delay" = "health system inefficiencies"
  ),
  "Patient-Related  Barrier" = c(
    "appraisal delay" = "perceived need for surgery",
    "fear" = "fear",
    "fear of hospitals" = "fear",
    "late presentation" = "perceived need for surgery",
    "literacy" = "perceived need for surgery",
    "perceived need" = "perceived need for surgery",
    "perceived need for surgery" = "perceived need for surgery",
    "perceived-need for surgery" = "perceived need for surgery"
  ),
  "Sociocultural Barrier" = c(
    "awareness" = "health literacy",
    "cultural beliefs" = "stigma and cultural beliefs",
    "delayed health seeking behavior" = "health literacy",
    "health literacy" = "health literacy",
    "medical literacy" = "health literacy",
    "religious belief" = "stigma and cultural beliefs",
    "stigma and cultural beliefs" = "stigma and cultural beliefs",
    "traditional medicine" = "stigma and cultural beliefs"
  )
)

# A helper function that replaces responses based on a named mapping vector:
assign_group <- function(responses, mapping) {
  # For each pattern in the mapping, vectorized replacement is applied.
  grouped <- responses
  for (pattern in names(mapping)) {
    # Use fixed() for exact string matching ignoring case
    grouped <- if_else(str_detect(responses, fixed(pattern, ignore_case = TRUE)),
                       mapping[[pattern]], grouped)
  }
  grouped
}

# Apply grouping per Barrier_Type if mapping exists; otherwise keep the original response.
barriers_clean_2 <- barriers_clean %>%
  group_by(Barrier_Type) %>%
  mutate(Grouped_Response = if (Barrier_Type[1] %in% names(mapping_list)) {
      assign_group(Response, mapping_list[[Barrier_Type[1]]])
    } else Response) %>%
  ungroup()

# Count occurrences
barrier_counts <- barriers_clean_2 %>%
  count(Barrier_Type, Grouped_Response)

# Create an extended palette similar to YlGnBu
unique_groups <- unique(barrier_counts$Grouped_Response)
num_groups <- length(unique_groups)
my_palette <- colorRampPalette(brewer.pal(9, "YlGnBu"))(num_groups)

```

```{r barrier stacked bar}
# Ensure the order of Barrier_Type is as specified
combined_barrier_data <- filtered_counts %>%
  mutate(Barrier_Type = fct_relevel(Barrier_Type,
                                    "Health System Barrier", 
                                    "Geograhic/Accessibility Barrier", 
                                    "Financial  Barrier", 
                                    "Education/Training Barrier", 
                                    "Policy/Governance  Barrier", 
                                    "Patient-Related  Barrier", 
                                    "Sociocultural Barrier"))

# Create the plot with counts displayed as 'n = <count>' and grouping by Barrier_Type
stackedbar_combined <- ggplot(combined_barrier_data, aes(x = Barrier_Type, y = n, fill = Grouped_Response)) +
  geom_bar(stat = "identity") +
  # Add counts with the 'n = ' prefix, centered in each segment
  geom_text(aes(label = paste("n = ", n)),
            position = position_stack(vjust = 0.5), size = 5, color = "black") +
  scale_fill_manual(values = my_palette) +
  theme_minimal() +
  labs(title = "Barriers to Surgical Care",
       x = "Types of Barriers",
       y = "Number of Responses",
       fill = "Grouped Response") +  # Change legend title to 'Grouped Response'
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),  
        axis.title = element_text(size = 14),                         
        plot.title = element_text(size = 16, face = "bold"),          
        legend.position = "top",                                      
        panel.grid = element_blank())                                 

# Display the plot
stackedbar_combined
```

# DALYs 

```{r general daly pie chart}

# Create summary data
daly_data <- pathology_daly %>% 
  group_by(general_category_of_pathology) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  mutate(general_category_of_pathology =
           case_when(general_category_of_pathology == "general pediatric surgery pathology" ~ "other",
                     TRUE ~ general_category_of_pathology))

# Compute the position of labels
daly_data <- daly_data %>% 
  arrange(desc(general_category_of_pathology)) %>%
  mutate(prop = n / sum(daly_data$n) *100) %>%
  mutate(ypos = cumsum(prop)- 0.5*prop )

# Basic piechart
daly_piechart <- 
  ggplot(daly_data, aes(x="", y=prop, fill=general_category_of_pathology)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() + 
  theme(legend.position="none") +
  
  geom_text(aes(y = ypos, 
                label = str_to_title(general_category_of_pathology)),
                color = if_else(daly_data$general_category_of_pathology == 
                                  "other", "darkgray", "white"),
            size=7) +
  scale_fill_brewer(palette="YlGnBu",
                    direction = -1)
#Display graph
daly_piechart

# Save graph
# ggsave(filename = here("images/daly_piechart.png"), plot = daly_piechart)

```


## Orofacial Clefts

```{r orofacial cleft dalys}
# Load African map data
africa <- ne_countries(scale = "medium", continent = "Africa", returnclass = "sf")

# Quick clean of data
burden_orofacialcleft <- burden_orofacialcleft %>% 
  filter(!country %in%  c("Central Africa", "Saharan Africa"))

# Join data + map values
africa_burden_cleft <- right_join(burden_orofacialcleft, africa, by = c("country" = "name"))

# Define color scale
study_fill_scale <- scale_fill_distiller(
  palette = "YlGnBu",
  na.value = "white",
  name = "DALYs per 100,000 people",
  direction = 1,
  breaks = seq(15, max(burden_orofacialcleft$dalys), 5),  # Set custom breaks
  labels = seq(15, max(burden_orofacialcleft$dalys), 5)  # Set custom labels
)

# Plot the refined choropleth map
geo_orofacial_dalys <- ggplot(data = africa_burden_cleft) +
  geom_sf(aes(fill = dalys), color = "gray50", size = 0.3) +
  study_fill_scale +
  labs(title = "Burden of Orofacial Clefts in Sub-Saharan Africa",
       caption = "Source: Kantar R.S., 2023") +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        panel.grid = element_blank()
        )

# Display graph
geo_orofacial_dalys

# Save image
# ggsave(filename = here("images/orofacial_cleft_dalys.png"), plot = geo_orofacial_dalys, bg = "white", height = 6)
```

## Burns

```{r dalys burns}
# Create the combined plot
burn_combined_plot <- burn_daly %>%
  ggplot(aes(x = time)) +
  
  # First line (Disability Score)
  geom_line(data = burn_daly %>% filter(score == "disability"), 
            aes(y = value), color = "#1F968BFF", linewidth = 1) +
  geom_point(data = burn_daly %>% filter(score == "disability"), 
             aes(y = value), color = "#440154FF", size = 2) +
  
  # Second line (Quality of Life Score) scaled to a secondary axis
  geom_line(data = burn_daly %>% filter(score == "quality of life"), 
            aes(y = value), color = "#92D050", linewidth = 1) +
  geom_point(data = burn_daly %>% filter(score == "quality of life"), 
             aes(y = value), color = "#482677FF", size = 2) +
  
  # X-axis settings
  scale_x_continuous(breaks = seq(0, 12, 3)) +
  
  # Y-axis settings
  scale_y_continuous(
    name = "Disability Score (WHODAS 2.0)", 
    sec.axis = sec_axis(~ ., name = "Quality of Life Score"),
    breaks = seq(0.00, 1.00, by = 0.25),
    limits = c(0,1)
  ) +
  
  labs(x = "Time (Months)") +
  theme_minimal() +
  
  # Adjust theme for better readability
  theme(
    axis.title.y.left = element_text(color = "#1F968BFF"),
    axis.title.y.right = element_text(color = "#92D050")
  )

burn_combined_plot

# Save plot
ggsave(filename = here("images/disability_qol_plot.png"), plot = burn_combined_plot, height = 4, width = 5,  bg = "white")

```


