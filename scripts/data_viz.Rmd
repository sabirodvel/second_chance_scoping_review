---
title: "Data Viz for March 27th Webinar"
author: "VALERA Camille Beatrice"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r global_chunk options, include = F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

```{r initial_setup}
if(!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, 
               here, 
               janitor, 
               reactable, 
               sf, 
               rnaturalearth, 
               reactable,
               plotly, 
               ggrepel,
               treemap #package to create treemap
               )
```

```{r dataset_load}
included_studies_mar10 <- read_csv(here("data/included_studies_march_10.csv"))

extracted_studies_mar10 <- read_csv(here("data/extracted_studies_march_10.csv"))
```

# Preliminary Findings

## Research Distribution & Trends

```{r publications over time}
publications_over_time <- included_studies_mar10 %>%
  group_by(`Published Year`) %>%
  summarise(Count = n()) %>%
  arrange(`Published Year`)

# Static plot
publications_years <- publications_over_time %>%
  ggplot(aes(x = `Published Year`, y = Count)) +
  geom_line(color = "#1F968BFF", size = 1) +
  geom_smooth(color = "darkgray", fill = "lightgray", size = 1, method = "loess") + # Add smooth line to show trend
  geom_point(color = "#440154FF", size = 2) +
  scale_x_continuous(breaks = seq(min(publications_over_time$`Published Year`), max(publications_over_time$`Published Year`), by = 5)) +  # Set x-axis in 5-year increments
  labs(
    title = "Research Output on Plastic Reconstructive Surgery in Sub-Saharan Africa",
    subtitle = "Tracking the number of studies published over time to understand growth \n of Plastic Reconstructive Surgery Research in SSA.",
    x = "Publication Year (5-year intervals)",
    y = "Number of Published Studies"
  ) +
  theme_minimal()
publications_years
 
# Interactive plot
ggplotly(publications_years)
```

```{r choropleth of study distribution}

# Process data: Count occurrences per country
country_counts <- extracted_studies_mar10 %>%
  separate_rows(Country, sep = ", ") %>%  # Separate multiple countries in one entry
  count(Country, name = "study_count")

# Load African map data
africa <- ne_countries(scale = "medium", continent = "Africa", returnclass = "sf")

# Merge study data with map
africa_data <- africa %>%
  left_join(country_counts, by = c("name" = "Country"))

# Define subregion colors
subregion_colors <- c(
  "Northern Africa" = "purple",
  "Western Africa" = "yellowgreen",
  "Central Africa" = "lightgray",
  "Eastern Africa" = "slategray",
  "Southern Africa" = "red"
)

# Plot the choropleth map
country_distribution <- 
  ggplot() +
  geom_sf(data = africa_data, aes(fill = study_count), color = "black", size = 0.3) +
  scale_fill_gradient(low = "lightgray", high = "darkred", na.value = "white", name = "Study Count") +
  geom_text_repel(data = africa_data, aes(label = ifelse(!is.na(study_count), paste0(name, " (n=", study_count, ")"), ""), geometry = geometry),
                  stat = "sf_coordinates", size = 3, color = "black") +
  labs(title = "Studies on Plastic Reconstructive Surgery in Sub-Saharan Africa",
       subtitle = "Based on extracted literature",
       caption = "Source: Covidence Dataset") +
  theme_minimal() +
  theme(legend.position = "right")
country_distribution

```

```{r trends}
#!! Requires to run `extracted_data_cleaning` to obtain categorized pathologies !!

# Create frequency table, removing NA values directly in summarize
pathology_distribution <- categorized_general_pathology %>% 
  separate_rows(category_gen_pathology, sep = "; ") %>%
  filter(!is.na(category_gen_pathology)) %>%  # Remove NA values
  group_by(category_gen_pathology) %>% 
  summarize(n = n()) %>%
  ungroup() %>% 
  arrange(desc(n))

# Create simple treemap
treemap(pathology_distribution,
            index="category_gen_pathology",
            vSize="n",
            type="index")

# Customized treemap
data_tree <- 
  treemap(pathology_distribution,
        index = "category_gen_pathology",  # Define the category to index by
        vSize = "n",                       # Define the size based on 'n'
        vColor = "n",                      # Color based on frequency
        type = "index",                    # Type of treemap (index-based)
        palette = "Blues",                   # Custom color palette
        title = "Pathology Distribution",   # Custom title
        fontsize.labels = 10,               # Adjust label font size
        fontcolor.labels = "black",      # Label font color
        align.labels = c("center", "center"),  # Align labels in the center
        border.col = "white",              # Border color around boxes
        border.lw = 2
        )

# More complex treemap (to be further defined)
data_tree <- 
  treemap(pathology_distribution,
        index = "category_gen_pathology",  # Define the category to index by
        vSize = "n",                       # Define the size based on 'n'
        type = "index",                    # Type of treemap (index-based)
        )

data_ggplot <- data_tree[["tm"]] %>%
  as_tibble() %>%
  arrange(desc(vSize)) %>%
  mutate(
    rank = row_number(),
    xmax = x0 + w,
    ymax = y0 + h,
    label_pathology = str_glue("{category_gen_pathology}\n({vSize})")
  )

p1 <- ggplot(data_ggplot) +
  geom_rect(
    aes(
      xmin = x0,
      ymin = y0,
      xmax = xmax,
      ymax = ymax,
      fill = category_gen_pathology
    ),
    size = 0.1,
    colour = "#1E1D23",
    alpha = 0.9
  ) +
  geom_text(
    aes(x = (x0 + xmax) / 2,     # Position text in the middle horizontally
      y = (y0 + ymax) / 2,       # Position text in the middle vertically
      label = label_pathology),
    size = 3,                    # Font size of the labels
    color = "black",             # Font color
    fontface = "bold"            # Bold font
            ) +
  scale_fill_manual(values = c("Burns" = "#FF6347",
                               "Congenital Malformations" = "#FFD700",
                               "Trauma" = "#00BFFF",
                               "Infectious Conditions" = "#32CD32",
                               "Cyst, Tumor & Cancer" = "turquoise")
                    ) +  # Customize colors
  labs(title = "Pathologies") +
  theme_void() + # Remove axis and background 
  theme(legend.position = "none")

# Display the plot
p1 # Normal plot

#ggplotly(p1) # Interactive plot (to be refined if needed)

```
